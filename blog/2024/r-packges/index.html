<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Should R packages document research results? | Code, Maps, and More </title> <meta name="author" content="Keenan Ganz"> <meta name="description" content="Perhaps, but only if you want to put in the effort"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%8E&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://s-kganz.github.io/blog/2024/r-packges/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="//"> Code, Maps, and More </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Should R packages document research results?</h1> <p class="post-meta"> Created in April 12, 2024 </p> <p class="post-tags"> <a href="//blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Recently I’ve been hard at work modeling leaf temperature in evergreen forests. For various reasons, ecologists love to write R packages. This means that existing data access APIs and modeling code will most likely be available as an R package. This is a good thing - R is easy to read, quick to learn, and has a vibrant community of volunteer maintainers. I strongly believe that research, especially data-intensive work, should be reproducible. In this vein I wanted to take my project, refactor it as an R package, and then publish it on GitHub alongside the (forthcoming) manuscript.</p> <p>How hard could that refactoring be? The answer: quite hard. R makes some fundamental design choices that make it difficult to go from a researcher’s typical R script to a package. In this post I’ll discuss a few reasons why this is so, and suggest a better way to package research.</p> <h2 id="the-beginning">The beginning</h2> <p>Let’s say you are a researcher and you work in R. You organize your projects around a series of <code class="language-plaintext highlighter-rouge">.R</code> files that are structured something like this.</p> <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">somePackage</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">anotherPackage</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">yetAnotherPackage</span><span class="p">)</span><span class="w">

</span><span class="n">...</span><span class="w">
</span><span class="n">Do</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">kind</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">analysis</span><span class="w">
</span><span class="n">...</span><span class="w">

</span><span class="c1"># Save results</span><span class="w">
</span><span class="n">write_csv</span><span class="p">(</span><span class="n">spicy_result</span><span class="p">,</span><span class="w"> </span><span class="s2">"data_out/spicy_result.csv"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div> <p>This structure supports the interactive workflow people love about R. In this mode, you rarely <code class="language-plaintext highlighter-rouge">source</code> a whole file. Instead you go line-by-line, inspect outputs and plots, and iterate on an initial idea. In other words, you are free to put code that does different things all in one file. As you iterate on one file, your stack of <code class="language-plaintext highlighter-rouge">library()</code> calls at the top will get pretty large, even if you aren’t necessarily using all those libraries later on (when is the last time you saw an R tutorial use <code class="language-plaintext highlighter-rouge">::</code>?) Your script is less a self-contained program, and more a sketchpad that you return to as your analysis evolves.</p> <p>Suppose further that you use a directory structure to separate your data, scripts, and other outputs in a project. I like a structure like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── scripts/
│   ├── util.R
│   └── models/
│       └── fit_my_model.R
├── data_in/
│   └── some_raw_data.csv
└── data_out/
    └── model_fit.csv
</code></pre></div></div> <p>This is very good practice to keep yourself organized.</p> <p>An important thing to note here is that <code class="language-plaintext highlighter-rouge">fit_my_model.R</code> might need access to functions in <code class="language-plaintext highlighter-rouge">util.R</code> to work. Assuming the working directory is the root of the project, you make these available with <code class="language-plaintext highlighter-rouge">source("scripts/util.R")</code> at the top of <code class="language-plaintext highlighter-rouge">fit_my_model.R</code>.</p> <h2 id="issue-1-everything-needs-to-be-a-function-now">Issue 1: Everything needs to be a function now</h2> <p>Step 1 in making a package from a jumble of standalone scripts is to start converting your code into functions. Although this is definitely work, there are two reasons why converting code to functions isn’t so bad. First, you can get off to a pretty good start by just surrounding a code block in <code class="language-plaintext highlighter-rouge">function() {...}</code> (RStudio even has a shortcut for this). Second, writing functions encourages modularity, keeps you from repeating yourself, and can get you to think harder about how you design your workflow. Still, depending on how late in your development process you decide to make a package, rewriting as functions can take a while.</p> <h2 id="issue-2-library-and-source-are-frowned-upon">Issue 2: <code class="language-plaintext highlighter-rouge">library()</code> and <code class="language-plaintext highlighter-rouge">source()</code> are frowned upon</h2> <p>When writing standalone scripts, <code class="language-plaintext highlighter-rouge">library()</code> and <code class="language-plaintext highlighter-rouge">source()</code> are effectively an informal dependency mechanism. You script depends on an external package if it attaches the package via <code class="language-plaintext highlighter-rouge">library()</code> at the top of the file. Likewise, your script depends on an external file via <code class="language-plaintext highlighter-rouge">source()</code>. In an R package, dependency rules are laid out formally in the DESCRIPTION file. Dependencies also have different “levels”. In order of importance, you dependencies can be listed under <code class="language-plaintext highlighter-rouge">Depends</code> (the dependency must be attached when your package loads), <code class="language-plaintext highlighter-rouge">Imports</code> (you call functions in the dependency, but the whole namespace doesn’t need to be loaded), or <code class="language-plaintext highlighter-rouge">Suggests</code> (the dependency is perhaps useful, but not required).</p> <p>Given this functionality, R packages should never use <code class="language-plaintext highlighter-rouge">library()</code>. Likewise, <code class="language-plaintext highlighter-rouge">source()</code> will never work in a package because you won’t know where your source code lives on the end user’s machine. I suppose you could get around that by hiding code in <code class="language-plaintext highlighter-rouge">inst/</code> and then using <code class="language-plaintext highlighter-rouge">system.file</code> to source it. Hacks like that are definitely not a good development pattern.</p> <p>So now we have to go through all our scripts and delete all the <code class="language-plaintext highlighter-rouge">library()</code> and <code class="language-plaintext highlighter-rouge">source()</code> calls. Not too much work. Then this raises another issue…</p> <h2 id="issuse-3-now-you-have-to-import-all-your-external-code">Issuse 3: Now you have to import all your external code</h2> <p>This is the first issue that took me a while to fix in my project. If you can’t make an external function available through <code class="language-plaintext highlighter-rouge">library()</code>, you have to list it in your package’s <code class="language-plaintext highlighter-rouge">DESCRIPTION</code> file and make it available accordingly. If you list an external package under <code class="language-plaintext highlighter-rouge">Depends</code>, you are done. External packages in <code class="language-plaintext highlighter-rouge">Depends</code> get attached when your package gets loaded, so it is as if you had called <code class="language-plaintext highlighter-rouge">library()</code> yourself. However, you can’t just spam every external package you used under <code class="language-plaintext highlighter-rouge">Depends</code>. There are <a href="https://recology.info/2018/10/limiting-dependencies/" rel="external nofollow noopener" target="_blank">general reasons not to</a>, but on a more practical level CRAN will reject packages that have too many dependencies.</p> <p>So how much work is it to make external functions available through <code class="language-plaintext highlighter-rouge">Imports</code>? The <code class="language-plaintext highlighter-rouge">usethis</code> package has a helpful function <code class="language-plaintext highlighter-rouge">use_import_from</code> that will take care of the bookkeeping in <code class="language-plaintext highlighter-rouge">DESCRIPTION</code> and <code class="language-plaintext highlighter-rouge">NAMESPACE</code>. The problem is that you now have to <em>manually call <code class="language-plaintext highlighter-rouge">use_import_from</code> for every external function in your package</em>. If you, like me, had a large codebase with mandatory dependencies, this is a boring process of running your code, seeing where it fails, adding an import, running again, and so on until you are almost-but-not-100%-sure that you imported everything correctly.</p> <h2 id="issue-4-all-your-rs-have-to-live-in-one-folder">Issue 4: All your .R’s have to live in one folder</h2> <p>Ok so you’ve done quite a bit of refactoring already. At this point you can probably <code class="language-plaintext highlighter-rouge">devtools::install</code> your package and do some proper testing. But, you may find that some of your own functions are not available. Why is this? In my case, it came down to the directory structure of the package. R packages have a mandatory structure. At minimum, an R package contains the following:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── DESCRIPTION
├── NAMESPACE
├── LICENSE
└── R/
</code></pre></div></div> <p>Here, <code class="language-plaintext highlighter-rouge">DESCRIPTION</code>, <code class="language-plaintext highlighter-rouge">NAMESPACE</code>, and <code class="language-plaintext highlighter-rouge">LICENSE</code> are fairly standard boilerplate files that can be auto-generated by the <code class="language-plaintext highlighter-rouge">devtools</code> package. Nothing too bad there. We hit a problem with the <code class="language-plaintext highlighter-rouge">R/</code> directory. This folder contains all of your files containing R code and <em>it is not allowed to have any subdirectories</em>. <a href="https://github.com/tidyverse/ggplot2/tree/main/R" rel="external nofollow noopener" target="_blank">No, really.</a>. A slightly amusing implication: <code class="language-plaintext highlighter-rouge">aaa.R</code> and <code class="language-plaintext highlighter-rouge">zzz.R</code> are conventionally used for hiding miscellaneous code that helps a package function so that they are easy to find in a directory. It definitely isn’t my place to comment on whether this was a good design choice. It is my place to argue that not allowing subfolders is a difference in convention between R users and R package developers that slows down package development. This also prevents developers from using submodules, like in Python, that encourage modular programming.</p> <p>Of all the issues here, this is perhaps the easiest one to fix. Simply dump all your files in R, make your filenames a little better, and you will be good to go.</p> <h2 id="conclusion-use-notebooks">Conclusion: Use notebooks</h2> <p>All told I spent <a href="https://github.com/s-kganz/LeafTemperature/pull/1" rel="external nofollow noopener" target="_blank">about a week refactoring</a> my project into an R package. Was it worth it? Probably not. The package barely works and I don’t plan on submitting it to CRAN. Does the package reproduce my science? Sure, if someone is motivated enough to get everything working.</p> <p>So if R packages are not the best vehicle for reproducibility, is there a better alternative? In my opinion, R notebooks <em>with the addition of functions in external files</em> are the best way to make your analysis reproducible. I have been skeptical of R notebooks because RStudio encourages you to knit them to another file format at the end of your analysis. This knitting process often brings up additional issues unrelated to the content of the notebook. Also, the development environment for R notebooks is seriously lacking. In RStudio only about 1/4 of the screen space is occupied by the notebook editor pane, results disappear when a code chunk is modified but not rerun, markdown chunks have to be rendered by the knitting process, and R objects are not displayed in a human-readable format by default (necessitating packages like <code class="language-plaintext highlighter-rouge">kable</code>). By contrast to the Python community, Jupyter Lab dedicates the whole screen to the notebook, results persist even when code is modified or rearranged, you can seamlessly toggle between raw and rendered markdown without having to go through a knitting process, and Python objects “know” how to display nicely in notebook format (e.g. <code class="language-plaintext highlighter-rouge">DataFrames</code>). Part of why Jupyter notebooks are so popular is that they blend the IDE with the finished product. R notebooks, in their current state, do not do this.</p> <p>Why are R notebooks the best option available despite these disadvantages? At least two alternatives, writing a package and sending someone your Git repo full of .R files, are much worse. You don’t have to follow rules about namespaces, so <code class="language-plaintext highlighter-rouge">library()</code> and <code class="language-plaintext highlighter-rouge">source()</code> are right at home in the notebook format and, by extension, you can spread any external files across subdirectories however you so choose and get at their functions with <code class="language-plaintext highlighter-rouge">source()</code>. Not everything has to be a function; R notebooks encourage the sketchpad-style of development that is endemic to standalone scripts. And even if you have to deal with the knitting process, notebooks capture output such that your work can be reproduced.</p> <p>TL;DR: is writing an R package to document research results worth it? No, unless you think your project will evolve into a tool. For documenting result, a notebook is your best bet.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Keenan Ganz. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: December 02, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>