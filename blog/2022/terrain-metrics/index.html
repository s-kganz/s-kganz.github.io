<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Terrain metrics, by hand in R | Code, Maps, and More </title> <meta name="author" content="Keenan Ganz"> <meta name="description" content="Slope and curvature by the Evans-Young method"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%8E&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://s-kganz.github.io/blog/2022/terrain-metrics/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="//"> Code, Maps, and More </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Terrain metrics, by hand in R</h1> <p class="post-meta"> Created in December 13, 2022 </p> <p class="post-tags"> <a href="//blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Let’s talk about terrain metrics. For all the time I have spent thinking about slope, relief, curvature, etc., I realized that I had never sat down and calculated these metrics from a DEM by hand. But, it is important to know why the terrain metrics tools we use in ArcGIs/QGIS/Earth Engine/whatever work. So, here is an R approach to calculating terrain metrics by hand.</p> <p>For much of this post, I’m following along with the description of the Evans-Young method given in <a href="https://www.sciencedirect.com/book/9780128046326/digital-terrain-analysis-in-soil-science-and-geology" rel="external nofollow noopener" target="_blank">Florinsky 2012</a>, but using the notation in the original: <a href="https://www.researchgate.net/publication/279414703" rel="external nofollow noopener" target="_blank">Young and Evans 1978</a> Most GIS applications and software packages use this technique.</p> <h1 id="the-evans-young-method">The Evans-Young method</h1> <p>Consider a DEM \(Z\) with regular grid spacing \(w\) with each cell containing an elevation value \(z\). Let us focus on a 3x3 window around a central cell. The eight cells adjacent to the central cell in this window is the eight-neighborhood of the central cell. We will refer to the elevation values in the eight-neighborhood as follows:</p> \[\begin{bmatrix} z_1 &amp; z_2 &amp; z_3 \\ z_4 &amp; z_5 &amp; z_6 \\ z_7 &amp; z_8 &amp; z_9 \\ \end{bmatrix}\] <p>The coordinates of each elevation value in the eight neighborhood are:</p> \[\begin{bmatrix} (-w, w) &amp; (0, w) &amp; (w, w) \\ (-w, 0) &amp; (0, 0) &amp; (w, 0) \\ (-w, -w) &amp; (0, -w) &amp; (w, -w) \\ \end{bmatrix}\] <p>The core of the Evans-Young method is to fit a second-degree polynomial to these elevation values, compute the partial derivatives of the polynomial, and then compute terrain metrics from the partial derivatives. The polynomial to be fit is:</p> \[\begin{align*} z = rx^2 + ty^2 + sxy + px + qy + u. \end{align*}\] <p>So, the partial derivatives correspond to the coefficients:</p> \[\begin{align*} p &amp;= \frac{\partial z}{\partial x} \newline\newline q &amp;= \frac{\partial z}{\partial y} \newline\newline 2r &amp;= \frac{\partial^2 z}{\partial x^2} \newline\newline s &amp;= \frac{\partial^2 z}{\partial x \partial y} \newline\newline 2t &amp;= \frac{\partial^2 z}{\partial y^2} \end{align*}\] <p>The last coefficient, \(u\), is not a partial derivative, but it is still a part of the fitting process. Now, we have to go about fitting the coefficients. To do this, we can make use of the fact that we can write values of \(z_i\) as a system of equations. Using the indexing above, we can write that:</p> \[\begin{align*} z_1 &amp;= w^2r + w^2t - w^2s - wp + wq + u \newline z_2 &amp;= 0 + w^2t + 0 + 0 + wq + u \newline z_3 &amp;= w^2r + w^2t + w^2s + wp + wq + u \newline \vdots \end{align*}\] <p>This is a system of equations! To solve the system, we need to rewrite it in matrix form. Let \(\vec{z}\) be a column vector of elevation values indexed as above and let the coefficient vector \(\vec{\alpha} = (r, t, s, p, q, u)^T\). We can now write a matrix equation describing our eight-neighborhood as:</p> \[\mathbf{F}\vec{\alpha} = \vec{z}\] <p>\(\mathbf{F}\) is the matrix of coefficients containing \(w\) that we got when writing out the first few equations for \(z_i\). The full matrix is:</p> \[F = \begin{bmatrix} w^2 &amp; w^2 &amp; -w^2 &amp; -w &amp; w &amp; 1 \\ 0 &amp; w^2 &amp; 0 &amp; 0 &amp; w &amp; 1 \\ w^2 &amp; w^2 &amp; w^2 &amp; w &amp; w &amp; 1 \\ w^2 &amp; 0 &amp; 0 &amp; -w &amp; 0 &amp; 1 \\ 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\ w^2 &amp; 0 &amp; 0 &amp; w &amp; 0 &amp; 1 \\ w^2 &amp; w^2 &amp; w^2 &amp; -w &amp; -w &amp; 1 \\ 0 &amp; w^2 &amp; 0 &amp; 0 &amp; -w &amp; 1 \\ w^2 &amp; w^2 &amp; w^2 &amp; w &amp; -w &amp; 1 \end{bmatrix}\] <p>Note that the \(i\)-th row of \(\mathbf{F}\) corresponds to the equation for \(z_i\). Now let’s return to our matrix equation. To solve for \(\vec{\alpha}\), we need to eliminate \(\mathbf{F}\) from the left-hand side. We cannot take the inverse of \(\mathbf{F}\) since it is not square. So, we will multiply both sides of the equation by \(\mathbf{F^T}\) to create the square matrix \(\mathbf{F^T F}\). Now we have:</p> \[\mathbf{F^T F}\vec{\alpha} = \mathbf{F^T}\vec{z}\] <p>Finally, multiply both sides by the inverse of the square matrix we just created:</p> \[(\mathbf{F^T F})^{-1}\mathbf{F^T F}\vec{\alpha} = (\mathbf{F^T F})^{-1}\mathbf{F^T}\vec{z}\] <p>Since the left-hand side contains a matrix multiplied by its inverse, we are left with a 6x6 identity matrix that cancels out, giving us our solution:</p> \[\vec{\alpha} = (\mathbf{F^T F})^{-1}\mathbf{F^T}\vec{z}\] <p>On the right-hand side, we have:</p> \[(\mathbf{F^T F})^{-1}\mathbf{F^T} = \begin{bmatrix} \frac{1}{6w^2} &amp; \frac{-1}{3w^2} &amp; \frac{1}{6w^2} &amp; \frac{1}{6w^2} &amp; \frac{-1}{3w^2} &amp; \frac{1}{6w^2} &amp; \frac{1}{6w^2} &amp; \frac{-1}{3w^2} &amp; \frac{1}{6w^2} \\ \frac{1}{6w^2} &amp; \frac{1}{6w^2} &amp; \frac{1}{6w^2} &amp; \frac{-1}{3w^2} &amp; \frac{-1}{3w^2} &amp; \frac{-1}{3w^2} &amp; \frac{1}{6w^2} &amp; \frac{1}{6w^2} &amp; \frac{1}{6w^2} \\ \frac{-1}{4w^2} &amp; 0 &amp; \frac{1}{4w^2} &amp; 0 &amp; 0 &amp; 0 &amp; \frac{1}{4w^2} &amp; 0 &amp; \frac{-1}{4w^2} \\ \frac{-1}{6w} &amp; 0 &amp; \frac{1}{6w} &amp; \frac{-1}{6w} &amp; 0 &amp; \frac{1}{6w} &amp; \frac{-1}{6w} &amp; 0 &amp; \frac{1}{6w} \\ \frac{1}{6w} &amp; \frac{1}{6w} &amp; \frac{1}{6w} &amp; 0 &amp; 0 &amp; 0 &amp; \frac{-1}{6w} &amp; \frac{-1}{6w} &amp; \frac{-1}{6w} \\ \frac{-1}{9} &amp; \frac{2}{9} &amp; \frac{-1}{9} &amp; \frac{2}{9} &amp; \frac{5}{9} &amp; \frac{2}{9} &amp; \frac{-1}{9} &amp; \frac{2}{9} &amp; \frac{-1}{9} \\ \end{bmatrix}\] <p>(Believe me, I had about as much fun writing that in latex as you had reading it.)</p> <p>Now we are in business. Take a closer look at the row corresponding to \(u\). The vertical displacement of the polynomial is not just an average of all the elevation values! Each partial derivative is derived from the dot product of a row of the above matrix with the elevation vector \(\vec{z}\). For example:</p> \[\frac{\partial^2 z}{\partial x^2} = 2r = \frac{z_1 + z_3 + z_4 + z_6 + z_7 + z_9 - 2(z_2 + z_5 + z_8)}{3w^2}\] <p>Before going any further, think about this equation in the context of the eight-neighborhood. The coefficients in front of the \(z_i\)’s match the below matrix.</p> \[\begin{bmatrix} 1 &amp; -2 &amp; 1 \\ 1 &amp; -2 &amp; 1 \\ 1 &amp; -2 &amp; 1 \\ \end{bmatrix}\] <p>So, you can think of the partial derivatives as <em>convolutions of the DEM</em>. We can then rewrite the partial derivative \(R\) (capitalized because it applies to the entire image) as:</p> \[R = Z \ast \begin{bmatrix} 1 &amp; -2 &amp; 1 \\ 1 &amp; -2 &amp; 1 \\ 1 &amp; -2 &amp; 1 \\ \end{bmatrix} / 3w^2\] <p>All the other partials follow suit:</p> \[\begin{align*} P &amp;= Z \ast \begin{bmatrix} -1 &amp; 0 &amp; 1 \\ -1 &amp; 0 &amp; 1 \\ -1 &amp; 0 &amp; 1 \\ \end{bmatrix} / 6w \newline \newline Q &amp;= Z \ast \begin{bmatrix} 1 &amp; 1 &amp; 1 \\ 0 &amp; 0 &amp; 0 \\ -1 &amp; -1 &amp; -1 \\ \end{bmatrix} / 6w \newline \newline S &amp;= Z \ast \begin{bmatrix} -1 &amp; 0 &amp; 1 \\ 0 &amp; 0 &amp; 0 \\ 1 &amp; 0 &amp; -1 \\ \end{bmatrix} / 4w^2 \newline \newline 2T &amp;= Z \ast \begin{bmatrix} 1 &amp; 1 &amp; 1 \\ -2 &amp; -2 &amp; -2 \\ 1 &amp; 1 &amp; 1 \\ \end{bmatrix} / 3w^2 \newline \end{align*}\] <p>As an aside, the fact that these partials come from convolutions makes them simple to calculate in Earth Engine. In fact, this is exactly how the <a href="https://github.com/zecojls/tagee" rel="external nofollow noopener" target="_blank">Terrain Analysis in Google Earth Engine</a> package computes terrain metrics.</p> <p>With our partials in hand, we can now calculate first and second-order terrain metrics. Slope is simply the gradient of the original DEM.</p> \[G = \sqrt{p^2 + q^2}\] <p>Note the similarity between \(G\) and the gradient of the polynomial, \(\nabla z = \sqrt{(\frac{\partial z}{\partial x})^2 + (\frac{\partial z}{\partial y})^2}\). These are the same property!</p> <p>Horizontal and vertical curvature (aka <a href="https://www.esri.com/arcgis-blog/products/product/imagery/understanding-curvature-rasters/" rel="external nofollow noopener" target="_blank">planform and profile curvature</a>) describe how slope changes in a landscape. They are used to describe the valley-ness or ridge-ness of a landform.</p> \[\begin{align*} k_h &amp;= -\frac{2q^2r - 4pqr + 2p^2 t}{(p^2 + q^2)\sqrt{1+p^2+q^2}} \newline \newline k_v &amp;= -\frac{2p^2r + 4pqs + 2q^2t}{(p^2+q^2)(1+p^2+q^2)^{1.5}} \end{align*}\] <h1 id="an-r-implementation">An R implementation</h1> <p>Let’s play with some terrain metrics in R. We will start with an 8-neighborhood, visualize its Evans-Young polynomial, then calculate terrain metrics for the center cell. First, we will simply translate our convolutions described above into R. For those playing along at home, all the code for this post is in <a href="https://github.com/s-kganz/terrain" rel="external nofollow noopener" target="_blank">this GitHub repository</a>.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">get_evans_young_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">6</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">7</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">9</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">5</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">8</span><span class="p">]))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">3</span><span class="o">*</span><span class="n">w</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w">
  </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">7</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">8</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">9</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">5</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">6</span><span class="p">]))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">3</span><span class="o">*</span><span class="n">w</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w">
  </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">7</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">9</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">4</span><span class="o">*</span><span class="n">w</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w">
  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">6</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">9</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">7</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">6</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="w">
  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">7</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">8</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="m">9</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">6</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="w">
  </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="m">9</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">2</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">4</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">6</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">8</span><span class="p">])</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">3</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">7</span><span class="p">]</span><span class="o">+</span><span class="n">z</span><span class="p">[</span><span class="m">9</span><span class="p">])</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">5</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="m">5</span><span class="p">])</span><span class="w">
  
  </span><span class="nf">list</span><span class="p">(</span><span class="w">
    </span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>Now, we use the <code class="language-plaintext highlighter-rouge">plotly</code> library to render the resulting polynomial.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">plotly</span><span class="p">)</span><span class="w">
</span><span class="n">render_evans_young_fit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">partials</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_evans_young_fit</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w">
  </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">r</span><span class="w">
  </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">t</span><span class="w">
  </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">s</span><span class="w">
  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">p</span><span class="w">
  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">q</span><span class="w">
  </span><span class="n">u</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">u</span><span class="w">
  
  </span><span class="c1"># The valid range of the polynomial is *always* [-1, 1] for both x</span><span class="w">
  </span><span class="c1"># and y axes.</span><span class="w">
  </span><span class="n">x_surf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="o">=</span><span class="m">100</span><span class="p">)</span><span class="w">
  </span><span class="n">y_surf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">length.out</span><span class="o">=</span><span class="m">100</span><span class="p">)</span><span class="w">
  </span><span class="n">z_surf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">nrow</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">x_surf</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">y_surf</span><span class="p">))</span><span class="w">
  
  </span><span class="c1"># This can be made much more efficient</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">x_surf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">y_surf</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="c1"># Note flip of j and i here since y is our "row" on the surface.</span><span class="w">
      </span><span class="n">z_surf</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">r</span><span class="o">*</span><span class="n">x_surf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="o">/</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="n">y_surf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">^</span><span class="m">2</span><span class="o">/</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s</span><span class="o">*</span><span class="n">x_surf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">y_surf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w">
        </span><span class="n">p</span><span class="o">*</span><span class="n">x_surf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">*</span><span class="n">y_surf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">u</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="n">x_pts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w">
  </span><span class="n">y_pts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">),</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">))</span><span class="w">
  
  </span><span class="n">plot_ly</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">add_surface</span><span class="p">(</span><span class="w">
      </span><span class="n">x</span><span class="o">=</span><span class="n">x_surf</span><span class="p">,</span><span class="w">
      </span><span class="n">y</span><span class="o">=</span><span class="n">y_surf</span><span class="p">,</span><span class="w">
      </span><span class="n">z</span><span class="o">=</span><span class="n">z_surf</span><span class="p">,</span><span class="w">
      </span><span class="n">opacity</span><span class="o">=</span><span class="m">0.5</span><span class="w">
    </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">add_markers</span><span class="p">(</span><span class="w">
      </span><span class="n">x</span><span class="o">=</span><span class="n">x_pts</span><span class="p">,</span><span class="w">
      </span><span class="n">y</span><span class="o">=</span><span class="n">y_pts</span><span class="p">,</span><span class="w">
      </span><span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="w">
    </span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="n">z</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="w">
    </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w">
    </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w">
    </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">render_evans_young_fit</span><span class="p">(</span><span class="n">z</span><span class="p">)</span></code></pre></figure> <iframe width="100%" height="400" frameborder="0" scrolling="no" src="//plotly.com/~ganzk/52.embed"></iframe> <p>We can also calculate terrain metrics for this surface.</p> <figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">get_terrain_metrics</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">partials</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_evans_young_fit</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w">
  </span><span class="n">r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">r</span><span class="w">
  </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">t</span><span class="w">
  </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">s</span><span class="w">
  </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">p</span><span class="w">
  </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">partials</span><span class="o">$</span><span class="n">q</span><span class="w">
  
  </span><span class="n">slope</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">atan</span><span class="p">(</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">^</span><span class="m">2</span><span class="o">+</span><span class="n">q</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="w"> </span><span class="c1"># in rads</span><span class="w">
  
  </span><span class="c1"># If p and q are both zero then the curvature result is 0/0, </span><span class="w">
  </span><span class="c1"># force to 0 since the surface is flat in this case.</span><span class="w">
  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">h_curv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
    </span><span class="n">v_curv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">h_curv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">q</span><span class="o">^</span><span class="m">2</span><span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">^</span><span class="m">2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w">
      </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="m">1</span><span class="o">+</span><span class="n">p</span><span class="o">^</span><span class="m">2</span><span class="o">+</span><span class="n">q</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">
    </span><span class="n">v_curv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">^</span><span class="m">2</span><span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">s</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">^</span><span class="m">2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w">
      </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="o">^</span><span class="m">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="o">+</span><span class="n">p</span><span class="o">^</span><span class="m">2</span><span class="o">+</span><span class="n">q</span><span class="o">^</span><span class="m">2</span><span class="p">)</span><span class="o">^</span><span class="m">1.5</span><span class="w"> </span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="n">relief</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">max</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="m">5</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">z</span><span class="p">))</span><span class="w">
  </span><span class="n">grad</span><span class="w">   </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">relief</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">w</span><span class="w">
  
  
  </span><span class="nf">list</span><span class="p">(</span><span class="n">slope</span><span class="o">=</span><span class="n">slope</span><span class="p">,</span><span class="w"> </span><span class="n">h_curv</span><span class="o">=</span><span class="n">h_curv</span><span class="p">,</span><span class="w"> </span><span class="n">v_curv</span><span class="o">=</span><span class="n">v_curv</span><span class="p">,</span><span class="w">
       </span><span class="n">relief</span><span class="o">=</span><span class="n">relief</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="o">&gt;</span><span class="w"> </span><span class="n">get_terrain_metrics</span><span class="p">(</span><span class="n">z1</span><span class="p">)</span><span class="w">
</span><span class="o">$</span><span class="n">slope</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">0.8410687</span><span class="w">

</span><span class="o">$</span><span class="n">h_curv</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">-0.2222222</span><span class="w">

</span><span class="o">$</span><span class="n">v_curv</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">0.1975309</span><span class="w">

</span><span class="o">$</span><span class="n">relief</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">2</span><span class="w">

</span><span class="o">$</span><span class="n">grad</span><span class="w">
</span><span class="p">[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="m">2</span></code></pre></figure> <p>Note that this approach to calculating terrain metrics may differ from that in your favorite GIS software. Another popular technique is given in <a href="doi.org/10.1109/PROC.1981.11918">Horn (1981)</a>, and is currently in use in the R <code class="language-plaintext highlighter-rouge">raster</code> package.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Keenan Ganz. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: November 21, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id="></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>